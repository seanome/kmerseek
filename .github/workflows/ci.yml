name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [1.82.0, stable, nightly]
        include:
          - rust: 1.82.0
            cache-key: "1.82.0"
          - rust: stable
            cache-key: stable
          - rust: nightly
            cache-key: nightly

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.cache-key }}

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

      - name: Run CLI tests
        run: cargo test tests::test_cli --verbose

      - name: Generate coverage report
        if: matrix.rust == 'stable'
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --output-dir coverage/

      - name: Upload coverage to Codecov
        if: matrix.rust == 'stable'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Build release
        run: cargo build --release --verbose

      - name: Test CLI binary
        run: |
          cargo run --bin kmerseek-rust -- --help
          cargo run --bin kmerseek-rust -- index --help

  cli-integration:
    name: CLI Integration Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.82.0

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release

      - name: Test CLI with real data
        run: |
          # Test basic indexing
          cargo run --bin kmerseek-rust -- index \
            --input tests/testdata/fasta/ced9.fasta \
            --output test_output.db \
            --ksize 5 \
            --encoding protein

          # Test gzipped file
          cargo run --bin kmerseek-rust -- index \
            --input tests/testdata/fasta/bcl2_first25_uniprotkb_accession_O43236_OR_accession_2025_02_06.fasta.gz \
            --output test_output_gz.db \
            --ksize 10 \
            --encoding hp

          # Test different encodings
          cargo run --bin kmerseek-rust -- index \
            --input tests/testdata/fasta/ced9.fasta \
            --output test_output_dayhoff.db \
            --ksize 8 \
            --encoding dayhoff

          # Verify outputs exist
          ls -la test_output*.db

      - name: Cleanup
        if: always()
        run: rm -rf test_output*.db

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.82.0

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: cargo bench --verbose -- --output-format json > benchmark_results.json

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: "cargo"
          output-file-path: benchmark_results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: "150%"
          fail-on-alert: false
          benchmark-data-dir-path: "dev/bench"
